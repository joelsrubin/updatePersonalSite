<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <meta name="theme-color" content="#967bb6" />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <title>Joel Rubin</title>
    <link rel="apple-touch-icon" href="./assets/baseball.png" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header>
      <div class="header_container">
        <h2 class="name">
          <span>Guest Book</span>
        </h2>

        <p>
          <a href="index.html">Back</a>
        </p>
      </div>
    </header>
    <main>
      <section class="guest-container">
        <div class="guest-book"></div>
        <form class="inputs">
          <div class="input-container">
            <label>name</label>
            <input type="text" class="sign-book" name="name" required />
          </div>
          <div class="input-container">
            <label>message</label>
            <input type="text" class="sign-book" name="message" required />
          </div>
          <button type="submit" id="submit">submit</button>
        </form>
      </section>
    </main>
    <footer>
      <p>&copy; Joel Rubin <span id="year">2023</span></p>
    </footer>
  </body>
  <script>
    const yearSpan = document.getElementById('year');
    const guestBook = document.querySelector('.guest-book');
    const submitButton = document.getElementById('submit');

    function createEntry({ name, message }) {
      const messageSpan = document.createElement('span');
      messageSpan.classList.add('message');
      messageSpan.innerHTML = `<b>${name}:</b> <div id="message-text">${message}</div>`;
      return messageSpan;
    }

    async function handleSubmit(e) {
      const name = e.currentTarget.name.value;
      const message = e.currentTarget.message.value;

      await fetch(
        `https://api.val.town/v1/run/Joelsrubin.signGuestBook?args=[{"name": "${name}", "message": "${message}"}]`
      );
      e.target.reset();
    }

    async function refreshList() {
      const messages = await getMessages();
      const divs = [];
      messages.forEach((message) => {
        divs.push(createEntry(message));
      });

      while (guestBook.firstChild) {
        guestBook.removeChild(guestBook.firstChild);
      }
      divs.forEach((newDiv) => {
        guestBook.appendChild(newDiv);
      });
    }

    async function getMessages() {
      const data = await fetch(
        'https://api.val.town/v1/run/Joelsrubin.guestBook'
      );
      const result = await data.json();
      return result;
    }
    function setYear() {
      const currentYear = new Date().getFullYear();
      yearSpan.innerHTML = currentYear;
    }

    const form = document.querySelector('.inputs');
    form.addEventListener('submit', async (e) => {
      submitButton.toggleAttribute('disabled');
      e.preventDefault();
      await handleSubmit(e);
      await refreshList();
      window.scrollTo({
        top: 0,
        left: 0,
        behavior: 'smooth',
      });
      submitButton.toggleAttribute('disabled');
    });

    (async () => {
      setYear();
      await refreshList();
    })();
  </script>
</html>
